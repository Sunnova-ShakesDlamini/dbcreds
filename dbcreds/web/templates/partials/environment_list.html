<!-- dbcreds/web/templates/partials/environment_list.html -->
{% if environments %}
<div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
    <table class="min-w-full divide-y divide-gray-300">
        <thead class="bg-gray-50">
            <tr>
                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">
                    Environment
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                    Type
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                    Description
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                    Password Expiry
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                    Status
                </th>
                <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                    <span class="sr-only">Actions</span>
                </th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
            {% for env in environments %}
            <tr>
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">
                    {{ env.name }}
                    {% if env.is_production %}
                    <span class="ml-2 inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                        Production
                    </span>
                    {% endif %}
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    {{ env.database_type.value }}
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    {{ env.description or "-" }}
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" id="expiry-{{ env.name }}">
                    <span class="text-gray-400">Loading...</span>
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                        Active
                    </span>
                </td>
                <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                    <a href="#" 
                       hx-get="/environments/{{ env.name }}/edit" 
                       hx-target="#modal"
                       class="text-indigo-600 hover:text-indigo-900">Edit</a>
                    <span class="text-gray-300 mx-2">|</span>
                    <a href="#" 
                       hx-post="/environments/{{ env.name }}/test" 
                       hx-target="#test-result-{{ env.name }}"
                       class="text-indigo-600 hover:text-indigo-900">Test</a>
                    <div id="test-result-{{ env.name }}" class="mt-1"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Script to load expiry information -->
<script>
// Updated loadExpiryInfo function for environment_list.html

function loadExpiryInfo(envName) {
    fetch("/api/environments/" + envName + "/expiry")
        .then(response => response.json())
        .then(data => {
            const element = document.getElementById("expiry-" + envName);
            if (!element) return;
            
            if (data.error) {
                console.error("Error fetching expiry data:", data.error);
                element.innerHTML = "<span class=\"text-gray-400\">Unable to load</span>";
                return;
            }
            
            // Check if we have update date but no expiry date stored
            if (data.updated_at && !data.expires_at && data.expires_days) {
                // Calculate theoretical expiry
                const updateDate = new Date(data.updated_at);
                const theoreticalExpiry = new Date(updateDate);
                theoreticalExpiry.setDate(theoreticalExpiry.getDate() + data.expires_days);
                
                const now = new Date();
                const daysLeft = Math.floor((theoreticalExpiry - now) / (1000 * 60 * 60 * 24));
                
                if (daysLeft <= 0) {
                    element.innerHTML = "<span class=\"text-red-600 font-medium\">Expired (not tracked)</span>";
                } else if (daysLeft <= 7) {
                    element.innerHTML = "<span class=\"text-red-600\">" + daysLeft + " days left (not tracked)</span>";
                } else if (daysLeft <= 30) {
                    element.innerHTML = "<span class=\"text-yellow-600\">" + daysLeft + " days left (not tracked)</span>";
                } else {
                    element.innerHTML = "<span class=\"text-blue-600\">" + daysLeft + " days left (not tracked)</span>";
                }
                
                element.title = "Password updated on: " + updateDate.toLocaleDateString() + 
                              "\nWould expire on: " + theoreticalExpiry.toLocaleDateString() + 
                              "\n(Expiry not being tracked - click Edit to enable)";
            } else if (data.is_expired) {
                element.innerHTML = "<span class=\"text-red-600 font-medium\">Expired</span>";
            } else if (data.days_left !== null) {
                if (data.days_left <= 7) {
                    element.innerHTML = "<span class=\"text-red-600\">" + data.days_left + " days left</span>";
                } else if (data.days_left <= 30) {
                    element.innerHTML = "<span class=\"text-yellow-600\">" + data.days_left + " days left</span>";
                } else {
                    element.innerHTML = "<span class=\"text-green-600\">" + data.days_left + " days left</span>";
                }
                
                // Add expires date as tooltip/title
                if (data.expires_at) {
                    const expiresDate = new Date(data.expires_at);
                    const formattedDate = expiresDate.toLocaleDateString();
                    element.title = "Expires on: " + formattedDate;
                }
            } else if (data.updated_at) {
                // If no expiry but we have update date, show as not tracked
                const updatedDate = new Date(data.updated_at);
                element.innerHTML = "<span class=\"text-gray-500\">Not tracked</span>";
                element.title = "Password updated on: " + updatedDate.toLocaleDateString() + 
                              "\nExpiry tracking not enabled";
            } else {
                element.innerHTML = "<span class=\"text-gray-400\">No expiry set</span>";
            }
        })
        .catch(error => {
            console.error("Error loading expiry:", error);
            const element = document.getElementById("expiry-" + envName);
            if (element) {
                element.innerHTML = "<span class=\"text-gray-400\">Error loading</span>";
            }
        });
}

function loadAllExpiryInfo() {
    {% for env in environments %}
    loadExpiryInfo("{{ env.name }}");
    {% endfor %}
}

// Initial load
document.addEventListener("DOMContentLoaded", loadAllExpiryInfo);

// For HTMX updates
document.body.addEventListener("htmx:afterSwap", function(event) {
    if (event.detail.target.id === "environment-list") {
        setTimeout(loadAllExpiryInfo, 100);  // Small delay to ensure DOM is updated
    }
});

// Call immediately in case DOM is already loaded
loadAllExpiryInfo();
</script>
{% else %}
<!-- Empty state -->
<div class="py-6 text-center">
    <p class="text-gray-500">No environments configured yet. Add one to get started.</p>
</div>
{% endif %}
